function New-UriWithQuery {
    [CmdletBinding()]
    [OutputType([System.Uri])]
    param (
        [Parameter(Mandatory = $true)]
        [System.Uri]$Uri,

        [Parameter(Mandatory = $true)]
        [hashtable]$Query,

        [Parameter(Mandatory = $false)]
        [Alias('filteredParmeters')]
        [array]$FilteredParameters
    )

    $uriBuilder = [System.UriBuilder]::New($Uri.AbsoluteUri)
    $blockedKeys = 'Verbose', 'Force', 'Debug', 'WhatIf' + $FilteredParameters
    $keys = $Query.Keys | Where-Object { $blockedKeys -notcontains $_ }

    foreach ($param in $keys) {
        if (($null -ne $Query[$param]) -and ($null -ne $param)) {
            $paraCaseSensitive = $param.ToString()[0].ToString().ToLower() + $param.ToString().Substring(1)
            if ( $Query[$param] -is [array]) {
                $QueryPart = $paraCaseSensitive + '=' + ($Query[$param] -join ',')
            } else {
                #convert time time to ISO 8601 Universal Format Specifier
                if ($Query[$param].GetType().Name -eq 'DateTime') {
                    $Query[$param] = $Query[$param].ToUniversalTime().ToString('u').Replace(' ', 'T')
                }
                $QueryPart = $paraCaseSensitive + '=' + $Query[$param]
            }
            if (($null -eq $uriBuilder.Query) -or ($uriBuilder.Query.Length -le 1 )) {
                $uriBuilder.Query = $QueryPart
            } else {
                $uriBuilder.Query = $uriBuilder.Query.Substring(1) + '&' + $QueryPart
            }
        }
    }

    [System.Uri]::New($uriBuilder.Uri)
}
